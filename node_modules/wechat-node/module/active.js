/**
 * 主动发送消息
 */
var token = require("./access_token");
var request = require("request");
var active = function(openid,content,callback,isLast) {
	if(typeof openid === "string")
		openid = [openid];
	token.getToken(function(ok, result) {
			if (!ok) {
				callback(false, result);
				return;
			}
			var url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=" + result;
			for(var i in openid)
			{
				var data = {
				    "touser": openid[i],
				    "msgtype":"text",
				    "text":
				    {
				         "content":content
				    }
				};
				request({
					url: url,
					method : 'POST',
					form: JSON.stringify(data)
				},
				(function(i) {
					return function(err,res,body) {
						if(err)
						{
							callback(false,err);
							return;
						}
					    body = JSON.parse(body);
						if(body.errcode === 0)
						{
							if(isLast)
							{
								if(i - 0 === openid.length - 1)
								{
									console.log(i + " " + (openid.length - 1));
									callback(true,body.errmsg);		
								}
							}
							else
							{
								// console.log(2);
								callback(true,body.errmsg);
								
							}
						}
						else
						{
							// console.log(3);
							callback(false,body.errmsg);
						}

					}
				})(i)
				);
			}

		});
}


exports.active = active;